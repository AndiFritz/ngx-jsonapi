!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("rxjs"),require("rxjs/operators"),require("axios"),require("lodash-es")):"function"==typeof define&&define.amd?define(["exports","rxjs","rxjs/operators","axios","lodash-es"],t):t(e["ngx-jsonapi"]={},e.rxjs,e.operators,e.axios,e.lodashEs)}(this,function(e,s,a,c,i){"use strict";c=c&&c.hasOwnProperty("default")?c.default:c;var n,t=(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])},function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),o=function(r,i){var n,o,s,e,a={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,o&&(s=2&t[0]?o.return:t[0]?o.throw||((s=o.return)&&s.call(o),0):o.next)&&!(s=s.call(o,t[1])).done)return s;switch(o=0,s&&(t=[2&t[0],s.value]),t[0]){case 0:case 1:s=t;break;case 4:return a.label++,{value:t[1],done:!1};case 5:a.label++,o=t[1],t=[0];continue;case 7:t=a.ops.pop(),a.trys.pop();continue;default:if(!(s=0<(s=a.trys).length&&s[s.length-1])&&(6===t[0]||2===t[0])){a=0;continue}if(3===t[0]&&(!s||t[1]>s[0]&&t[1]<s[3])){a.label=t[1];break}if(6===t[0]&&a.label<s[1]){a.label=s[1],s=t;break}if(s&&a.label<s[2]){a.label=s[2],a.ops.push(t);break}s[2]&&a.ops.pop(),a.trys.pop();continue}t=i.call(r,a)}catch(e){t=[6,e],o=0}finally{n=s=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}};var r=function(){this.number=1,this.total_resources=0,this.size=0,this.resources_per_page=0},u=(p.propagateLoaded=function(e,t){for(var r in e){var i=e[r];i instanceof P&&i.setLoaded(t&&i.builded)}},p);function p(){}var d=(h.prototype.applyParams=function(e,t){if(void 0===t&&(t={}),this.appendPath(e.getPrePath()),t.beforepath&&this.appendPath(t.beforepath),this.appendPath(e.getPath()),t.include&&this.setInclude(t.include),function(e){return void 0!==e.id||void 0!==e.include_get||void 0!==e.include_save}(t)&&t.include_get&&this.setInclude(this.includes.concat(t.include_get)),t.fields&&0<Object.keys(t.fields).length)for(var r in t.fields){var i="fields["+r+"]="+t.fields[r].join(",");this.get_params.push(i)}},h.prototype.appendPath=function(e){""!==e&&this.paths.push(e)},h.prototype.getForCache=function(){return this.paths.join("/")+this.get_params.join("/")},h.prototype.get=function(){var e=this.get_params.slice();return 0<this.includes.length&&e.push("include="+this.includes.join(",")),this.paths.join("/")+(0<e.length?k.getInstance().injectedServices.rsJsonapiConfig.params_separator+e.join("&"):"")},h.prototype.setInclude=function(e){this.includes=e},h);function h(){this.paths=[],this.includes=[],this.get_params=[]}var l=(f.json_array2resources_array_by_type=function(e){var t={},r={};for(var i in f.json_array2resources_array(e,t),t){var n=t[i];n.type in r||(r[n.type]={}),r[n.type][n.id]=n}return r},f.json2resource=function(e,t){if(f.getService(e.type))return f.procreate(e);k.getInstance().isDevMode()&&console.warn("`"+e.type+"`","service not found on json2resource().","Use @Autoregister() on service and inject it on component.");var r=new j;return r.id=e.id,r.type=e.type,r},f.getService=function(e){return k.me.getResourceService(e)},f.getServiceOrFail=function(e){return k.me.getResourceServiceOrFail(e)},f.buildIncluded=function(e){return"included"in e&&e.included?f.json_array2resources_array_by_type(e.included):{}},f.procreate=function(e){"type"in e&&"id"in e||console.error("Jsonapi Resource is not correct",e);var t=F.getInstance().getOrCreateResource(e.type,e.id);return t.fill({data:e}),t.is_new=!1,t},f.json_array2resources_array=function(e,t){void 0===t&&(t={});for(var r=0,i=e;r<i.length;r++){var n=i[r],o=f.json2resource(n,!1);t[o.type+"_"+o.id]=o}},f);function f(){}function v(){this.builded=!1,this.is_loading=!0,this.loaded=!1,this.source="new",this.cache_last_update=0,this.meta={}}var g,y=(t(_,g=v),_.prototype.fill=function(e){this.builded=!1,this.content="id",null!==e?(this.data||(this.data=F.getInstance().getOrCreateResource(e.data.type,e.data.id)),this.data.fill(e)&&(this.builded=!0,this.content="resource"),this.meta=e.meta||{}):this.data=null},_.prototype.unsetData=function(){this.data=void 0,this.builded=!1},_);function _(){var e=g.apply(this,arguments)||this;return e.data=new j,e.builded=!1,e.content="id",e}var b=(m.prototype.buildRelationships=function(){for(var e in this.relationships_from){var t=this.relationships_from[e];this.relationships_dest[e]&&null===t.data&&(this.relationships_dest[e].data=null,this.relationships_dest[e].builded=!0,this.relationships_dest[e].is_loading=!1,this.relationships_dest[e].loaded=!0),t.data&&(this.relationships_dest[e]instanceof P?this.__buildRelationshipHasMany(t,e):this.relationships_dest[e]instanceof y&&this.__buildRelationshipHasOne(t,e))}},m.prototype.__buildRelationshipHasMany=function(e,t){if(0===e.data.length)return this.relationships_dest[t]=new P,void(this.relationships_dest[t].builded=!0);this.relationships_dest[t].fill(e)},m.prototype.__buildRelationshipHasOne=function(e,t){if("type"in e.data){if(this.relationships_dest[t].data||(this.relationships_dest[t].data=new j),e.data.id!==this.relationships_dest[t].data.id&&(this.relationships_dest[t].data=new j,this.relationships_dest[t].data.type=e.data.type),this.relationships_dest[t].data.id!==e.data.id||!this.relationships_dest[t].data.attributes||0===Object.keys(this.relationships_dest[t].data.attributes).length){var r=this.__buildRelationship(e.data);r?(this.relationships_dest[t].data=r,this.relationships_dest[t].builded=!0):(this.relationships_dest[t].data.id=e.data.id,this.relationships_dest[t].data.type=e.data.type)}}else this.relationships_dest[t].data=[]},m.prototype.__buildRelationship=function(e){if(e.type in this.included_resources&&e.id in this.included_resources[e.type]){var t=this.included_resources[e.type][e.id];return F.getInstance().setResource(t,!0),t}this.getService(e.type);var r=F.getInstance().getResource(e.type,e.id);if(r)return r},m);function m(e,t,r,i){this.getService=e,this.relationships_from=t,this.relationships_dest=r,this.included_resources=i}var j=(w.prototype.reset=function(){for(var e in this.id="",this.attributes={},this.is_new=!0,this.relationships)this.relationships[e]=this.relationships[e]instanceof P?new P:new y},w.prototype.toObject=function(e){var t,r={},i=[],n=[],o=(e=Object.assign({},x.ParamsResource,e)).include||[];for(var s in e.include_save&&(o=o.concat(e.include_save)),this.relationships){var a=this.relationships[s];if(a instanceof P){a.builded||a.data&&0!==a.data.length?r[s]={data:[]}:delete r[s];for(var c=0,u=a.data;c<u.length;c++){var p=u[c],d={id:p.id,type:p.type};r[s].data.push(d);var h=p.type+"_"+p.id;-1===n.indexOf(h)&&o&&-1!==o.indexOf(s)&&(n.push(h),i.push(p.toObject({}).data))}}else{if(null===a.data||void 0===a.data){r[s]={data:a.data};continue}a instanceof y||console.warn(a," is not DocumentCollection or DocumentResource");var l=a.data;if(a.data&&!("id"in a.data)&&0<Object.keys(a.data).length&&console.warn(s+" defined with hasMany:false, but I have a collection"),l.id&&l.type)r[s]={data:{id:l.id,type:l.type}};else if(!a.builded&&!l.id&&!l.type){delete r[s];continue}h=l.type+"_"+l.id,-1===n.indexOf(h)&&o&&-1!==o.indexOf(s)&&(n.push(h),i.push(l.toObject({}).data))}}this.getService()&&this.getService().parseToServer?(t=Object.assign({},this.attributes),this.getService().parseToServer(t)):t=this.attributes;var f={data:{type:this.type,id:this.id,attributes:t,relationships:r}};return this.meta&&(f.data.meta=this.meta),e.meta&&(f.meta=e.meta),0<i.length&&(f.included=i),f},w.prototype.fill=function(e){this.id=e.data.id||"",this.attributes=Object.assign({},this.attributes||{},e.data.attributes),this.is_new=!1;var t=l.getService(e.data.type);if(!this.relationships&&t&&(this.relationships=(new t.resource).relationships),!t)return!1;if(Object.keys(this.attributes).length){var r=l.getService(this.type);r&&"parseFromServer"in r&&r.parseFromServer(this.attributes)}return"cache_last_update"in e.data&&(this.cache_last_update=e.data.cache_last_update),new b(l.getService,e.data.relationships||{},this.relationships,l.buildIncluded(e)).buildRelationships(),!0},w.prototype.addRelationship=function(e,t){var r=this.relationships[t||e.type];r instanceof P?r.replaceOrAdd(e):r.data=e},w.prototype.addRelationships=function(e,t){var r=this;if(0!==e.length){if(!(this.relationships[t]instanceof P))throw new Error("addRelationships require a DocumentCollection (hasMany) relation.");e.forEach(function(e){r.addRelationship(e,t)})}},w.prototype.removeRelationship=function(e,t){if(!(e in this.relationships))return!1;if(!("data"in this.relationships[e]))return!1;var r=this.relationships[e];return r instanceof P?(r.data=r.data.filter(function(e){return e.id!==t}),0===r.data.length&&(r.builded=!0)):r.data=null,!0},w.prototype.hasManyRelated=function(e){return this.relationships[e]&&0<this.relationships[e].data.length},w.prototype.hasOneRelated=function(e){return Boolean(this.relationships[e]&&this.relationships[e].data.type&&""!==this.relationships[e].data.type)},w.prototype.restore=function(e){return void 0===e&&(e={}),e.meta=Object.assign({},e.meta,{restore:!0}),this.save(e)},w.prototype.getService=function(){return l.getServiceOrFail(this.type)},w.prototype.delete=function(){return this.getService().delete(this.id)},w.prototype.save=function(e){var t=this;if(e=Object.assign({},x.ParamsResource,e),this.is_saving||!this.loaded)return s.of({});this.is_saving=!0;var r=new s.Subject,i=this.toObject(e);""===this.id&&delete i.data.id;var n=new d;return n.applyParams(this.getService(),e),this.id&&n.appendPath(this.id),k.exec(n.get(),this.is_new?"POST":"PATCH",i,!0).subscribe(function(e){t.is_saving=!1,t.id||(F.getInstance().deprecateCollections(n.get()),k.getInstance().injectedServices.json_ripper.deprecateCollection(n.get())),"id"in e.data?(t.id=e.data.id,t.fill(e)):Array.isArray(e.data)&&console.warn("Server return a collection when we save()",e.data),r.next(e),r.complete()},function(e){t.is_saving=!1,r.error("data"in e?e.data:e)}),r},w.prototype.setLoaded=function(e){this.is_loading=!e,this.loaded=e},w.prototype.setLoadedAndPropagate=function(e){this.setLoaded(e),u.propagateLoaded(this.relationships,e)},w.prototype.setSource=function(e){this.source=e},w.prototype.setSourceAndPropagate=function(e){for(var t in this.setSource(e),this.relationships){var r=this.relationships[t];r instanceof P&&r.setSource(e)}},w.prototype.setCacheLastUpdate=function(e){void 0===e&&(e=Date.now()),this.cache_last_update=e},w);function w(){this.id="",this.type="",this.attributes={},this.relationships={},this.links={},this.is_new=!0,this.is_saving=!1,this.is_loading=!1,this.loaded=!0,this.source="new",this.cache_last_update=0,this.ttl=0}var S,R=(t(O,S=v),O.prototype.trackBy=function(e,t){return t.id},O.prototype.find=function(e){if("ids"===this.content)return null;for(var t=0;t<this.data.length;t++)if(this.data[t].id===e)return this.data[t];return null},O.prototype.fill=function(e){l.buildIncluded(e),this.page&&e.meta&&(this.page.number=e.meta.page||1,this.page.resources_per_page=e.meta.resources_per_page||null,this.page.size=e.meta.resources_per_page||null,this.page.total_resources=e.meta.total_resources||null);var t={};this.data.length=0,this.builded=e.data&&0===e.data.length;for(var r=0,i=e.data;r<i.length;r++){var n=i[r];try{var o=this.getResourceOrFail(n);o.fill({data:n}),t[n.id]=n.id,this.data.push(o),0<Object.keys(o.attributes).length&&(this.builded=!0)}catch(e){this.content="ids",this.builded=!1,this.data.push({id:n.id,type:n.type})}}for(var s=void 0;s<this.data.length;s++)this.data[s].id in t||delete this.data[s];this.meta=e.meta||{},"cache_last_update"in e&&(this.cache_last_update=e.cache_last_update)},O.prototype.getResourceOrFail=function(e){var t=this.find(e.id);if(null!==t)return t;var r=l.getService(e.type);if(!r)throw k.getInstance().isDevMode()&&console.warn("The relationship relation_alias? (type "+e.type+") cant be generated because service for this type has not been injected."),new Error("Cant create service for "+e.type);return r.getOrCreateResource(e.id)},O.prototype.replaceOrAdd=function(e){var t=this.find(e.id);null===t?this.data.push(e):t=e},O.prototype.hasMorePages=function(){return!this.page.size||this.page.size<1?null:this.page.size*(this.page.number-1)+this.data.length<this.page.total_resources},O.prototype.setLoaded=function(e){this.is_loading=!e,this.loaded=e},O.prototype.setLoadedAndPropagate=function(t){this.setLoaded(t),"ids"!==this.content&&this.data.forEach(function(e){u.propagateLoaded(e.relationships,t)})},O.prototype.setBuilded=function(e){this.builded=e},O.prototype.setBuildedAndPropagate=function(t){this.setBuilded(t),"ids"!==this.content&&this.data.forEach(function(e){e.setLoaded(t)})},O.prototype.setSource=function(e){this.source=e},O.prototype.setSourceAndPropagate=function(t){this.setSource(t),this.data.forEach(function(e){e instanceof j&&e.setSource(t)})},O.prototype.setCacheLastUpdate=function(e){void 0===e&&(e=Date.now()),this.cache_last_update=e},O.prototype.setCacheLastUpdateAndPropagate=function(t){void 0===t&&(t=Date.now()),this.setCacheLastUpdate(t),this.data.forEach(function(e){e instanceof j&&e.setCacheLastUpdate(t)})},O.prototype.toObject=function(t){return this.builded?{data:this.data.map(function(e){return e.toObject(t).data})}:{data:this.data}},O);function O(){var e=S.apply(this,arguments)||this;return e.data=[],e.page=new r,e.ttl=0,e.content="ids",e}var C,P=(t(I,C=R),I);function I(){var e=C.apply(this,arguments)||this;return e.data=[],e.content="collection",e}var x=(E.newCollection=function(){return new P},E.isObjectLive=function(e,t){return 0<=e&&Date.now()<=t+1e3*e},E.forEach=function(t,r){Object.keys(t).forEach(function(e){r(t[e],e)})},E);function E(){}x.ParamsResource={beforepath:"",ttl:void 0,include:[],fields:{},id:""},x.ParamsCollection={beforepath:"",ttl:void 0,include:[],remotefilter:{},fields:{},smartfilter:{},sort:[],page:new r,store_cache_method:"individual",storage_ttl:0,cachehash:""};var F=(A.getInstance=function(){return A.instance||(A.instance=new A),A.instance},A.prototype.clearCache=function(){this.resources={},this.collections={},A.instance=null},A.prototype.getResource=function(e,t){return this.getKey(e,t)in this.resources?this.resources[this.getKey(e,t)]:null},A.prototype.getResourceOrFail=function(e,t){if(this.getKey(e,t)in this.resources)return this.resources[this.getKey(e,t)];throw new Error("The requested resource does not exist in cache memory")},A.prototype.getKey=function(e,t){return e+"."+t},A.prototype.getOrCreateCollection=function(e){return e in this.collections||(this.collections[e]=new P,this.collections[e].source="new"),this.collections[e]},A.prototype.setCollection=function(e,t){e in this.collections||(this.collections[e]=new P);for(var r=0;r<t.data.length;r++){var i=t.data[r];this.setResource(i,!0)}this.collections[e].data=t.data,this.collections[e].page=t.page,this.collections[e].cache_last_update=t.cache_last_update},A.prototype.getOrCreateResource=function(e,t){var r=this.getResource(e,t);return null!==r||((r=l.getServiceOrFail(e).new()).id=t,this.setResource(r,!1)),r},A.prototype.setResource=function(e,t){void 0===t&&(t=!1),this.getKey(e.type,e.id)in this.resources?this.fillExistentResource(e):this.resources[this.getKey(e.type,e.id)]=e,this.resources[this.getKey(e.type,e.id)].cache_last_update=t?Date.now():0},A.prototype.deprecateCollections=function(e){for(var t in void 0===e&&(e=""),this.collections)t.includes(e)&&(this.collections[t].cache_last_update=0);return!0},A.prototype.removeResource=function(r,i){var e=this.getResource(r,i);if(e){for(var t in x.forEach(this.collections,function(e,t){e.data.splice(e.data.findIndex(function(e){return e.type===r&&e.id===i}),1)}),e.attributes={},e.relationships)null!==e.relationships[t].data&&void 0!==e.relationships[t].data&&(e.relationships[t].data instanceof Array?e.relationships[t].data=[]:e.relationships[t].data instanceof Object&&delete e.relationships[t].data);delete this.resources[this.getKey(r,i)]}},A.prototype.fillExistentResource=function(e){var t=this.getResourceOrFail(e.type,e.id);t.attributes=Object.assign({},t.attributes,e.attributes),t.relationships=t.relationships||e.relationships},A);function A(){this.resources={},this.collections={}}function L(e,t){var r="number"==typeof t?t:e.ttl||0;return Date.now()<e.cache_last_update+1e3*r}function D(e,t,r){var i=r.value;return r.value=function(){var e,t=Array.prototype.slice.call(arguments);try{e="string"==typeof t[0]?t[0]:t[0].type}catch(e){return console.warn("ERROR: First argument of methods decorated with serviceIsRegistered has to be string or Resource."),null}return k.me.getResourceService(e)?i.apply(this,t):(console.warn("ERROR: "+e+" service has not been registered."),null)},r}var T=function(e,t,r,i){var n,o=arguments.length,s=o<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,i);else for(var a=e.length-1;0<=a;a--)(n=e[a])&&(s=(o<3?n(s):3<o?n(t,r,s):n(t,r))||s);return 3<o&&s&&Object.defineProperty(t,r,s),s},q=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},J=function(o,s,a,c){return new(a=a||Promise)(function(e,t){function r(e){try{n(c.next(e))}catch(e){t(e)}}function i(e){try{n(c.throw(e))}catch(e){t(e)}}function n(t){t.done?e(t.value):new a(function(e){e(t.value)}).then(r,i)}n((c=c.apply(o,s||[])).next())})},k=(M.getInstance=function(){return M.me||(M.me=new M),M.me},M.delete=function(e){return M.exec(e,"DELETE")},M.get=function(e){return M.exec(e,"get")},M.exec=function(e,t,r,i){return void 0===i&&(i=!0),M.me.refreshLoadings(1),M.getInstance().injectedServices.JsonapiHttp.exec(e,t,r).pipe(a.tap(function(){return M.me.refreshLoadings(-1)}),a.catchError(function(e){return e=e.error||e,M.me.refreshLoadings(-1),e.status<=0?!M.me.loadingsOffline(e)&&M.me.isDevMode()&&console.warn("Jsonapi.Http.exec (use JsonapiCore.loadingsOffline for catch it) error =>",e):i&&!M.me.loadingsError(e)&&M.me.isDevMode()&&console.warn("Jsonapi.Http.exec (use JsonapiCore.loadingsError for catch it) error =>",e),s.throwError(e)}))},M.prototype.registerService=function(e){return!(e.type in this.resourceServices)&&(this.resourceServices[e.type]=e)},M.prototype.getResourceService=function(e){return this.resourceServices[e]},M.prototype.getResourceServiceOrFail=function(e){var t=this.resourceServices[e];if(!t)throw new Error("The requested service with type "+e+" has not been registered, please use register() method or @Autoregister() decorator");return t},M.removeCachedResource=function(e,t){F.getInstance().removeResource(e,t)},M.setCachedResource=function(e){F.getInstance().setResource(e,!0)},M.deprecateCachedCollections=function(e){var t=M.me.getResourceServiceOrFail(e),r=new d;r.applyParams(t),F.getInstance().deprecateCollections(r.getForCache())},M.prototype.refreshLoadings=function(e){this.loadingsCounter+=e,0===this.loadingsCounter?this.loadingsDone():1===this.loadingsCounter&&this.loadingsStart()},M.prototype.clearCache=function(){return J(this,void 0,void 0,function(){return o(this,function(e){return M.getInstance().injectedServices.JsonapiStoreService.clearCache(),F.getInstance().clearCache(),[2,M.getInstance().injectedServices.json_ripper.deprecateCollection("").then(function(){return!0})]})})},M.prototype.duplicateResource=function(r){for(var i=this,n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];var o=this.getResourceServiceOrFail(r.type).new();function t(t){var e=r.relationships[t];if(!e.data)return o.relationships[t]=r.relationships[t],"continue";"id"in e.data?-1<n.indexOf(t)?o.addRelationship(s.duplicateResource(e.data),t):o.addRelationship(e.data,t):-1<n.indexOf(t)?e.data.forEach(function(e){o.addRelationship(i.duplicateResource(e),t)}):o.addRelationships(e.data,t)}o.id="new_"+Math.floor(1e4*Math.random()).toString(),o.attributes=Object.assign({},o.attributes,r.attributes);var s=this;for(var a in r.relationships)t(a);return o},M);function M(){this.loadingsCounter=0,this.loadingsStart=s.noop,this.loadingsDone=s.noop,this.loadingsError=s.noop,this.loadingsOffline=s.noop,this.isDevMode=function(){return!1},this.resourceServices={}}T([D,q("design:type",Function),q("design:paramtypes",[String,String]),q("design:returntype",void 0)],k,"removeCachedResource",null),T([D,q("design:type",Function),q("design:paramtypes",[j]),q("design:returntype",void 0)],k,"setCachedResource",null),T([D,q("design:type",Function),q("design:paramtypes",[String]),q("design:returntype",void 0)],k,"deprecateCachedCollections",null);var z=function(){this.url="http://yourdomain/api/v1/",this.params_separator="?",this.unify_concurrency=!0,this.cache_prerequests=!0,this.parameters={page:{number:"page[number]",size:"page[size]"}}},B=(K.prototype.exec=function(e,t,r){var i=this,n={url:k.me.injectedServices.rsJsonapiConfig.url+e,method:t,data:r||null,headers:{"Content-Type":"application/vnd.api+json",Accept:"application/vnd.api+json"}};if("get"!==t)return new s.Observable(function(t){c.request(n).then(function(e){t.next(e.data),t.complete()}).catch(function(e){t.error(e)})}).pipe(a.tap(function(){delete i.get_requests[e]}),a.share());if(this.get_requests[e])return this.get_requests[e];var o=new s.Observable(function(t){c.request(n).then(function(e){t.next(e.data),t.complete()}).catch(function(e){t.error(e)})}).pipe(a.tap(function(){delete i.get_requests[e]}),a.share());return this.get_requests[e]=o},K);function K(){this.get_requests={}}var H=function(o,s,a,c){return new(a=a||Promise)(function(e,t){function r(e){try{n(c.next(e))}catch(e){t(e)}}function i(e){try{n(c.throw(e))}catch(e){t(e)}}function n(t){t.done?e(t.value):new a(function(e){e(t.value)}).then(r,i)}n((c=c.apply(o,s||[])).next())})},U=(G.prototype.getDataObject=function(t,e){return H(this,void 0,void 0,function(){return o(this,function(e){return"collection"===t?[2,{data:[],cache_last_update:0}]:[2,{cache_last_update:Date.now(),id:"",type:""}]})})},G.prototype.getDataResources=function(e){return H(this,void 0,void 0,function(){return o(this,function(e){return[2,{}]})})},G.prototype.saveResource=function(e,t,r){},G.prototype.saveCollection=function(e,t){},G.prototype.clearCache=function(){},G.prototype.deprecateResource=function(e,t){},G.prototype.deprecateCollection=function(e){},G.prototype.removeObjectsWithKey=function(e){return H(this,void 0,void 0,function(){return o(this,function(e){return[2]})})},G);function G(){}var W=function(o,s,a,c){return new(a=a||Promise)(function(e,t){function r(e){try{n(c.next(e))}catch(e){t(e)}}function i(e){try{n(c.throw(e))}catch(e){t(e)}}function n(t){t.done?e(t.value):new a(function(e){e(t.value)}).then(r,i)}n((c=c.apply(o,s||[])).next())})},N=(V.prototype.getResource=function(e,t){return void 0===t&&(t=[]),W(this,void 0,void 0,function(){return o(this,function(e){return[2,{data:{id:"",type:"",cache_last_update:0}}]})})},V.prototype.getResourceByResource=function(t,r){return void 0===r&&(r=[]),W(this,void 0,void 0,function(){return o(this,function(e){return[2,this.getResource(t.type,r)]})})},V.prototype.getCollection=function(e,t){return void 0===t&&(t=[]),W(this,void 0,void 0,function(){return o(this,function(e){return[2,{data:[],cache_last_update:0}]})})},V.prototype.saveCollection=function(e,t,r){void 0===r&&(r=[])},V.prototype.saveResource=function(e,t){return void 0===t&&(t=[]),W(this,void 0,void 0,function(){return o(this,function(e){return[2]})})},V.toResourceElements=function(e,t,r){return void 0===r&&(r=[]),[]},V.prototype.deprecateCollection=function(e){return W(this,void 0,void 0,function(){return o(this,function(e){return[2]})})},V);function V(){this.enabled=!1}var Q=(X.bootstrap=function(e,t,r){var i=new z;for(var n in i)i[n]=void 0!==e[n]?e[n]:i[n];k.getInstance().injectedServices={JsonapiStoreService:t||new U,JsonapiHttp:new B,json_ripper:r||new N,rsJsonapiConfig:i}},X);function X(){}var Y,Z=(t($,Y=Q),$);function $(){return null!==Y&&Y.apply(this,arguments)||this}var ee=(te.prototype.toparams=function(e){var r=this,i="";return x.forEach(e,function(e,t){i+=r.toparamsarray(e,"&"+t)}),i.slice(1)},te.prototype.toparamsarray=function(e,r){var i=this,n="";return Array.isArray(e)||e instanceof Object?x.forEach(e,function(e,t){n+=i.toparamsarray(encodeURIComponent(e),r+"["+t+"]")}):n+=r+"="+e,n},te);function te(){}var re,ie=(t(ne,re=d),ne.prototype.applyParams=function(e,t){void 0===t&&(t={}),re.prototype.applyParams.call(this,e,t);var r=new ee;t.remotefilter&&0<Object.keys(t.remotefilter).length&&(e.parseToServer&&e.parseToServer(t.remotefilter),this.addParam(r.toparams({filter:t.remotefilter}))),t.page&&(1<t.page.number&&this.addParam(this.getPageConfig().number+"="+t.page.number),t.page.size&&this.addParam(this.getPageConfig().size+"="+t.page.size)),t.sort&&t.sort.length&&this.addParam("sort="+t.sort.join(","))},ne.prototype.getPageConfig=function(){return k.me.injectedServices.rsJsonapiConfig.parameters&&k.me.injectedServices.rsJsonapiConfig.parameters.page||{number:"number",size:"size"}},ne.prototype.addParam=function(e){this.get_params.push(e)},ne);function ne(){return null!==re&&re.apply(this,arguments)||this}var oe=(se.prototype.getResourceObject=function(){return this.resource_object},se.prototype.removeDuplicatedIncludes=function(){if(!this.resource_object.included||!this.parent_resource_object.included)return this;var e=this.parent_resource_object.included;return this.resource_object.included=this.resource_object.included.filter(function(t){return!i.isEqual(t,e.find(function(e){return e.id===t.id}))}),this.resource_object.included=this.resource_object.included.map(function(t){return e.find(function(e){return e.id===t.id})?new se(t,e.find(function(e){return e.id===t.id})).getResourceObject().data:t}),this},se.prototype.removeDuplicatedRelationships=function(){if(!this.resource_object.data.relationships||!this.parent_resource_object.data.relationships)return this;for(var e in this.resource_object.data.relationships)i.isEqual(this.resource_object.data.relationships[e],this.parent_resource_object.data.relationships[e])&&delete this.resource_object.data.relationships[e];return this},se.prototype.removeDuplicatedAttributes=function(){if(!this.resource_object.data.attributes||!this.parent_resource_object.data.attributes)return this;for(var e in this.resource_object.data.attributes)this.resource_object.data.attributes[e]===this.parent_resource_object.data.attributes[e]&&delete this.resource_object.data.attributes[e];return this},se);function se(e,t,r){this.parent_resource_object=t instanceof j?t.toObject(r):{data:t},!function(e){return e&&e.toObject&&"function"==typeof e.toObject&&e.superToObject&&"function"==typeof e.superToObject}(e)?this.resource_object={data:e}:this.resource_object=e.superToObject(r),this.removeDuplicatedAttributes(),this.removeDuplicatedRelationships(),this.removeDuplicatedIncludes()}var ae,ce=(t(ue,ae=j),ue.prototype.toObject=function(e){return new oe(this,this.parent,e).getResourceObject()},ue.prototype.superToObject=function(e){return ae.prototype.toObject.call(this,e)},ue.prototype.copySourceFromParent=function(){for(var e in this.source=this.parent.source,this.relationships)this.relationships[e].source=this.parent.relationships[e].source},ue);function ue(e){var t=ae.call(this)||this;t.parent=i.cloneDeep(e),t.type=t.parent.type,delete t.relationships;var r=Object.keys(t.parent.relationships);return t.fill(t.parent.toObject({include:r})),t.copySourceFromParent(),t}var pe=function(o,s,a,c){return new(a=a||Promise)(function(e,t){function r(e){try{n(c.next(e))}catch(e){t(e)}}function i(e){try{n(c.throw(e))}catch(e){t(e)}}function n(t){t.done?e(t.value):new a(function(e){e(t.value)}).then(r,i)}n((c=c.apply(o,s||[])).next())})},de=(he.prototype.register=function(){if(null===k.me)throw new Error("Error: you are trying register `"+this.type+"` before inject JsonapiCore somewhere, almost one time.");return k.me.registerService(this)},he.prototype.newResource=function(){return this.new()},he.prototype.newCollection=function(){return new P},he.prototype.new=function(){var e=new this.resource;return e.type=this.type,this.getService(),e.reset(),e},he.prototype.getPrePath=function(){return""},he.prototype.getPath=function(){return this.path||this.type},he.prototype.getClone=function(e,t){return void 0===t&&(t={}),this.get(e,t).pipe(a.map(function(e){return new ce(e)}))},he.prototype.get=function(e,t){var r=this;void 0===t&&(t={}),t=Object.assign({},x.ParamsResource,t);var i=new d;i.applyParams(this,t),i.appendPath(e);var n=this.getOrCreateResource(e);n.setLoaded(!1);var o=new s.BehaviorSubject(n);return 0<Object.keys(t.fields||[]).length?this.getGetFromServer(i,n,o):L(n,t.ttl)&&function(e,t){if(0===t.length)return 1;for(var r in e.relationships)if(t.includes(r)&&!e.relationships[r].builded)return 0;return 1}(n,t.include||[])?(n.setLoaded(!0),setTimeout(function(){return o.complete()},0)):0===n.cache_last_update?this.getGetFromLocal(t,i,n).then(function(){o.next(n),setTimeout(function(){return o.complete()},0)}).catch(function(){n.setLoaded(!1),r.getGetFromServer(i,n,o)}):this.getGetFromServer(i,n,o),o.asObservable()},he.prototype.getGetFromLocal=function(r,i,n){return void 0===r&&(r={}),pe(this,void 0,void 0,function(){var t;return o(this,function(e){switch(e.label){case 0:if(!k.getInstance().injectedServices.json_ripper.enabled)throw new Error("We cant handle this request");return n.setLoaded(!1),[4,k.getInstance().injectedServices.json_ripper.getResourceByResource(n,i.includes)];case 1:if(t=e.sent(),n.fill(t),n.setSource("store"),L(n,r.ttl))return n.setLoadedAndPropagate(!0),[2];throw new Error("Resource is dead!")}})})},he.prototype.getGetFromServer=function(t,r,i){k.get(t.get()).subscribe(function(e){r.fill(e),r.cache_last_update=Date.now(),r.setLoadedAndPropagate(!0),r.setSourceAndPropagate("server"),k.getInstance().injectedServices.json_ripper.saveResource(r,t.includes),i.next(r),setTimeout(function(){return i.complete()},0)},function(e){r.setLoadedAndPropagate(!0),i.next(r),i.error(e)})},he.prototype.getService=function(){return l.getService(this.type)||this.register()},he.prototype.getOrCreateCollection=function(e){var t=this.getService(),r=F.getInstance().getOrCreateCollection(e.getForCache());return r.ttl=t.collections_ttl,"new"!==r.source&&(r.source="memory"),r},he.prototype.getOrCreateResource=function(e){var t,r=l.getServiceOrFail(this.type);return null===(t=F.getInstance().getResource(this.type,e))&&((t=r.new()).id=e,F.getInstance().setResource(t,!1)),"new"!==t.source&&(t.source="memory"),t},he.prototype.createResource=function(e){var t=l.getServiceOrFail(this.type).new();return t.id=e,F.getInstance().setResource(t,!1),t},he.prototype.clearCacheMemory=function(){return pe(this,void 0,void 0,function(){return o(this,function(e){return[2,this.clearCache()]})})},he.prototype.clearCache=function(){return pe(this,void 0,void 0,function(){var t;return o(this,function(e){return(t=new d).applyParams(this),F.getInstance().deprecateCollections(t.getForCache()),[2,k.getInstance().injectedServices.json_ripper.deprecateCollection(t.getForCache()).then(function(){return!0})]})})},he.prototype.parseToServer=function(e){},he.prototype.parseFromServer=function(e){},he.prototype.delete=function(t,e){var r=this;e=Object.assign({},x.ParamsResource,e);var i=new d;i.applyParams(this,e),i.appendPath(t);var n=new s.Subject;return k.delete(i.get()).subscribe(function(e){F.getInstance().removeResource(r.type,t),n.next(),n.complete()},function(e){n.error(e)}),n.asObservable()},he.prototype.all=function(e){var t=this;void 0===e&&(e={});var r=Object.assign({},x.ParamsCollection,e);r.ttl||0===r.ttl||(r.ttl=this.collections_ttl);var i=new ie;i.applyParams(this,r);var n=this.getOrCreateCollection(i);n.page.number=1*r.page.number;var o=new s.BehaviorSubject(n);return 0<Object.keys(r.fields).length?this.getAllFromServer(i,r,n,o):L(n,r.ttl)?setTimeout(function(){return o.complete()},0):0===n.cache_last_update?(n.source="new",this.getAllFromLocal(r,i,n).then(function(){o.next(n),setTimeout(function(){o.complete()},0)}).catch(function(){n.setLoaded(!1),t.getAllFromServer(i,r,n,o)})):this.getAllFromServer(i,r,n,o),o.asObservable()},he.prototype.getAllFromLocal=function(r,i,n){return void 0===r&&(r={}),pe(this,void 0,void 0,function(){var t;return o(this,function(e){switch(e.label){case 0:if(!k.getInstance().injectedServices.json_ripper.enabled)throw new Error("We cant handle this request");return n.setLoaded(!1),"compact"!==r.store_cache_method?[3,2]:[4,k.getInstance().injectedServices.JsonapiStoreService.getDataObject("collection",i.getForCache()+".compact")];case 1:return t=e.sent(),[3,4];case 2:return[4,k.getInstance().injectedServices.json_ripper.getCollection(i.getForCache(),i.includes)];case 3:t=e.sent(),e.label=4;case 4:if(n.fill(t),n.setSourceAndPropagate("store"),L(n,r.ttl))return n.setLoadedAndPropagate(!0),n.setBuildedAndPropagate(!0),[2];throw new Error("Collection is dead!")}})})},he.prototype.getAllFromServer=function(i,n,o,s){o.setLoaded(!1),k.get(i.get()).subscribe(function(e){if(n.cachehash)for(var t in e.data){var r=e.data[t];r.id=r.id+n.cachehash}o.fill(e),o.cache_last_update=Date.now(),o.setCacheLastUpdateAndPropagate(),o.setSourceAndPropagate("server"),o.setLoadedAndPropagate(!0),k.getInstance().injectedServices.json_ripper.enabled&&(k.getInstance().injectedServices.json_ripper.saveCollection(i.getForCache(),o,i.includes),"compact"===n.store_cache_method&&k.getInstance().injectedServices.JsonapiStoreService.saveCollection(i.getForCache()+".compact",e)),s.next(o),setTimeout(function(){return s.complete()},0)},function(e){o.setLoadedAndPropagate(!0),s.next(o),s.error(e)})},he);function he(){var e=this;this.resource=j,setTimeout(function(){return e.register()})}e.Autoregister=function(){return function(e){}},e.JsonapiCore=k,e.JSONAPI_RIPPER_SERVICE="jsonapi_ripper_service",e.JSONAPI_STORE_SERVICE="jsonapi_store_service",e.Resource=j,e.ReactBootstrap=Z,e.AngularBootstrap=Q,e.DocumentResource=y,e.DocumentCollection=P,e.Service=de,e.ɵb=v,e.ɵa=R,Object.defineProperty(e,"__esModule",{value:!0})});